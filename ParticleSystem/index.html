<!DOCTYPE html>

<html>

<head>
	<title>Learning WebGL &mdash; lesson 1</title>
	<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
	<!-- glMatrix version 2.2.0 -->
	<script type="text/javascript" src="gl-matrix-min.js"></script>
	<script id="vertex-save" type="x-shader/x-vertex">
		
		precision mediump float;
		//attribute vec3 aVertexAccelerations;
	    //attribute vec3 aVertexVelocities; //rename aParticleVelocities
	    attribute vec2 aParticleIndex; 


	    uniform int uTextureSideLength;
	    uniform sampler2D uParticleVelocities;
 	    uniform sampler2D uParticlePositions; 
  	    const int max_Iterations = 64;

	   	uniform float uTime;

	    varying vec4 newPosition;
	   	varying vec3 newVelocity;
	   	
	   	//vec3 getAccellerationFromBody(){}
	   	
	   	vec3 accumulateAcceleration(vec4 position,float uvStep){
	   		vec3 accelleration = vec3(0.0);
	   		
	   		vec2 otherUv = vec2(0.0);

	   		for(int i = 0; i < max_Iterations; i++){
	   			
	   			for(int j = 0; j < max_Iterations; j++){
	   				
	   				
	   				
	   				vec4 otherPosition = texture2D(uParticlePositions, otherUv);
	   				vec3 distance = (otherPosition.rgb - position.rgb);
	   				float distanceSquared = dot(distance,distance);

	   				if(distanceSquared > 0.00000000001){
						accelleration += position.a * otherPosition.a * distance * (0.000001/distanceSquared);
	   					
	   				}
	   				otherUv.y += uvStep;
	   				
	   			}
	   			otherUv.x += uvStep; 
	   		}
	   		return accelleration / position.a;
	   	}
	
	
	    void main(void) {
		   	vec4 oldPosition = texture2D(uParticlePositions, aParticleIndex);
		   	vec4 oldVelocity = texture2D(uParticleVelocities, aParticleIndex);
		   /*
		   	float moddy = mod(uTime,4.0);
		   	if( moddy > 1.0 && moddy < 3.0){

		   		oldVelocity *= -1.0;
		   	}
			*/


			//float uvStep = rand(aParticleIndex) * 0.030125;
			float uvStep = 1.0 / float(max_Iterations);// float(uTextureSideLength);
			vec3 accellerationFinal = accumulateAcceleration(oldPosition,uvStep);
			
		    newVelocity = oldVelocity.rgb + accellerationFinal;
		    // if(length(newVelocity) > 10.0){
		    // 	newVelocity /= 50.0;
		    // }
		    // if(length(newVelocity) > 20.0){
		    // 	newVelocity *= -1.0;// length(newVelocity);
		    // }
		   

			// updated position to be written to texture in frag shader
			
			newPosition = vec4(oldPosition.rgb + newVelocity,oldPosition.a);

			// if(length(newPosition) > 6.0)
			// {
			// 	newPosition = vec3(0.0);
			// }
			vec2 glSpaceIndex = 2.0 * (aParticleIndex - 0.5);
			// set data write location 
	    	gl_Position = vec4(glSpaceIndex, 0.0, 1.0); 
	    	
	    	// Set particle size
	    	gl_PointSize = 1.0;
	    }

	</script>
	<script id="fragment-save" type="x-shader/x-fragment">
		#extension GL_EXT_draw_buffers : require
	    precision mediump float;
	 
	    varying vec4 newPosition;
	   	varying vec3 newVelocity;

	    void main(void) {
	    	// Saves the new position and accelleration to location determined in vertex shader
  			gl_FragData[0] = (newPosition);
  			gl_FragData[1] = vec4(newVelocity,1.0);
	    }
	</script>

	<script id="vertex-render" type="x-shader/x-vertex">
		
		precision lowp float;

	    //attribute vec3 aVertexVelocities; //rename aParticleVelocities
	    attribute vec2 aParticleIndex; 
	   
	   	uniform sampler2D uParticleVelocities;
 	    uniform sampler2D uParticlePositions;  //rename uParticlePositions
	    uniform mat4 uMVMatrix; // necessary?
	    uniform mat4 uPMatrix;
	    
	   
	   	varying vec4 v_color;
	   	
	    void main(void) {
	    
	    	// Index into the buffer uParticlePositions with aParticleIndex 
			vec4 oldPosition = texture2D(uParticlePositions, aParticleIndex);
			vec3 oldVelocity = texture2D(uParticleVelocities, aParticleIndex).rgb;	    		
	       	gl_Position = uPMatrix * uMVMatrix * vec4(oldPosition.rgb, 1.0);//write 
	       	//gl_Position =0c4(aParticleIndex,0.0,1.0);

	       	gl_PointSize = 0.8 +  0.4 * oldPosition.a;

	       	// ---SET COLOR
	       	float magnitude = length(oldVelocity + 1.0);
			v_color = vec4(oldPosition.a,1.0,1.0,0.2);
			//gl_Position = vec4(v_color - 0.5,1.0);
			//v_color = (oldPosition);
			//v_color = vec3(1.0);
			//v_color = (oldVelocity);
		    // ---
	    }

	</script>
	<script id="fragment-render" type="x-shader/x-fragment">
	    precision lowp float;
	    	
	   	varying vec4 v_color;
	    void main(void) {
	    	
    			//gl_FragColor = vec4(v_color, 0.4);
    			gl_FragColor = v_color;
   		    }
	</script>
	<script src="Particle.js" type="text/javascript"></script>
	<script src="ParticleSystem.js" type="text/javascript"></script>
	<script src="View.js" type="text/javascript"></script>
	</head>

<body onload= "webGLStart();">
	<canvas id="glcanvas" width="600" height="600">
		Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
	</canvas>
	<label for="particleCount" id="particleCountid">1024 Particles</label>
	<input id="particleCount" type="range" min=6 max=11 step=1 value=7>
</body>



