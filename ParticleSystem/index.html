<!DOCTYPE html>

<html>

<head>
	<title>Learning WebGL &mdash; lesson 1</title>
	<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
	<!-- glMatrix version 2.2.0 -->
	<script type="text/javascript" src="gl-matrix-min.js"></script>
	<script id="vertex-save" type="x-shader/x-vertex">
		
		precision highp float;
		//attribute vec3 aVertexAccelerations;
	    //attribute vec3 aVertexVelocities; //rename aParticleVelocities
	    attribute vec2 aParticleIndex; 


	    uniform int uTextureSideLength;
	    uniform sampler2D uParticleVelocities;
 	    uniform sampler2D uParticlePositions; 
 	    const float cheatLength = 512.0;
 	    const int cheatLengthLoop = 512;

	   	uniform float uTime;

	    varying vec3 newPosition;
	   	varying vec3 newVelocity;
	   	
	   	//vec3 getAccellerationFromBody(){}
	   	
	   	vec3 accumulateAcceleration(vec3 position){
	   		vec3 accelleration = vec3(0.0);
	   		float uvStep = 1.0 / cheatLength;
	   		vec2 otherUv = vec2(0.0);

	   		for(int i = 0; i < cheatLengthLoop; i+= 128){
	   			otherUv.x += uvStep; 
	   			for(int j = 0; j < cheatLengthLoop; j+=128){
	   				
	   				otherUv.y += uvStep;
	   				
	   				vec3 otherPosition = texture2D(uParticlePositions, otherUv).rgb;
	   				vec3 distance = (otherPosition - position);
	   				float distanceSquared = dot(distance,distance);

	   				if(distanceSquared > 0.00000000001){
						accelleration += distance * (0.000001 * 128.0 * (0.1/distanceSquared));
	   					
	   				}
	   				
	   				
	   				// accelleration += 0.00000001 * length(otherPosition - position);
	   			}
	   		}
	   		return accelleration;
	   	}
	
	    void main(void) {
		   	vec3 oldPosition = texture2D(uParticlePositions, aParticleIndex).rgb;
		   	vec3 oldVelocity = texture2D(uParticleVelocities, aParticleIndex).rgb;
		   /*
		   	float moddy = mod(uTime,4.0);
		   	if( moddy > 1.0 && moddy < 3.0){

		   		oldVelocity *= -1.0;
		   	}
			*/

			vec3 accellerationFinal = accumulateAcceleration(oldPosition);
			
		    newVelocity = oldVelocity + accellerationFinal;
		    // if(length(newVelocity) > 10.0){
		    // 	newVelocity /= 50.0;
		    // }
		    // if(length(newVelocity) > 20.0){
		    // 	newVelocity *= -1.0;// length(newVelocity);
		    // }
		   

			// updated position to be written to texture in frag shader
			
			newPosition = oldPosition + newVelocity;
			// if(length(newPosition) > 6.0)
			// {
			// 	newPosition = vec3(0.0);
			// }
			vec2 glSpaceIndex = 2.0 * (aParticleIndex - 0.5);
			// set data write location 
	    	gl_Position = vec4(glSpaceIndex, 0.0, 1.0); 
	    	
	    	// Set particle size
	    	gl_PointSize = 1.0;
	    }

	</script>
	<script id="fragment-save" type="x-shader/x-fragment">
		#extension GL_EXT_draw_buffers : require
	    precision highp float;
	 
	    varying vec3 newPosition;
	   	varying vec3 newVelocity;

	    void main(void) {
	    	// Saves the new position and accelleration to location determined in vertex shader
  			gl_FragData[0] = vec4(newPosition, 1.0);
  			gl_FragData[1] = vec4(newVelocity,1.0);
	    }
	</script>

	<script id="vertex-render" type="x-shader/x-vertex">
		
		precision lowp float;

	    //attribute vec3 aVertexVelocities; //rename aParticleVelocities
	    attribute vec2 aParticleIndex; 
	   
	   	uniform sampler2D uParticleVelocities;
 	    uniform sampler2D uParticlePositions;  //rename uParticlePositions
	    uniform mat4 uMVMatrix; // necessary?
	    uniform mat4 uPMatrix;
	    
	   
	   	varying vec3 v_color;
	   	
	    void main(void) {
	    
	    	// Index into the buffer uParticlePositions with aParticleIndex 
			vec3 oldPosition = texture2D(uParticlePositions, aParticleIndex).rgb;
			vec3 oldVelocity = texture2D(uParticleVelocities, aParticleIndex).rgb;	    		
	       	gl_Position = uPMatrix * uMVMatrix * vec4(oldPosition, 1.0);//write 
	       	//gl_Position = vec4(aParticleIndex,0.0,1.0);

	       	gl_PointSize = 1.0;

	       	// ---SET COLOR
			v_color = vec3(aParticleIndex, 0.0);
			//gl_Position = vec4(v_color - 0.5,1.0);
			//v_color = (oldPosition);
			//v_color = vec3(1.0);
			v_color = abs(oldVelocity);
		    // ---
	    }

	</script>
	<script id="fragment-render" type="x-shader/x-fragment">
	    precision lowp float;
	    	
	   	varying vec3 v_color;
	    void main(void) {
	    	
    			gl_FragColor = vec4(v_color, 0.4);
   		    }
	</script>
	<script src="Particle.js" type="text/javascript"></script>
	<script src="ParticleSystem.js" type="text/javascript"></script>
	<script src="View.js" type="text/javascript"></script>
	</head>

<body onload= "webGLStart();">
	<canvas id="glcanvas" width="1024" height="1024">
		Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
	</canvas>
</body>



